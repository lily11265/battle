# Discord 봇 스킬 시스템 완전 기획서

## 1. 시스템 개요

24시간 작동하는 Discord 봇의 전투 시스템에 영웅 스킬 시스템을 추가하는 프로젝트입니다.

### 핵심 컨셉
- 영웅들의 힘을 빌려서 전투하는 시스템
- 영웅 이름이 스킬 이름
- `/스킬` 명령어로 사용
- 기존 `/몹_세팅` 전투 시스템과 완전 통합

---

## 2. 파일 구조

```
skills/
├── skill.py                    # 메인 스킬 관리자 + /스킬 명령어
├── skill_manager.py            # 스킬 상태 관리 (JSON 저장/로드, 라운드 관리)
├── skill_effects.py            # 공통 스킬 효과들 (데미지 계산, 주사위 보정 등)
├── config/
│   ├── skill_config.json       # 전역 설정 (루센시아 nn,mm값, 특별 유저 ID 등)
│   └── user_skills.json        # 각 유저별 사용 가능한 스킬 목록
├── data/
│   ├── skill_states.json       # 현재 활성화된 스킬 상태
│   └── skill_backup.db         # 봇 재시작 대비 백업 DB
└── heroes/                     # 영웅별 스킬 파일들
    ├── __init__.py
    ├── onixel.py              # 오닉셀 스킬
    ├── scarnel.py             # 스카넬 스킬
    ├── lucencia.py            # 루센시아 스킬
    ├── virella.py             # 비렐라 스킬
    ├── grim.py                # 그림 스킬
    ├── phoenix.py             # 피닉스 스킬
    ├── oriven.py              # 오리븐 스킬
    ├── coal_fold.py           # 콜 폴드 스킬
    ├── hwangya.py             # 황야 스킬
    ├── karon.py               # 카론 스킬
    ├── nixara.py              # 닉사라 스킬
    ├── volken.py              # 볼켄 스킬
    ├── danmok.py              # 단목 스킬
    ├── jerrunka.py            # 제룬카 스킬
    ├── stravos.py             # 스트라보스 스킬
    └── nexis.py               # 넥시스 스킬
```

---

## 3. /스킬 명령어 구조

### 3.1 기본 옵션들
- **옵션1**: 영웅 선택 (드롭다운, 필수)
- **옵션2**: 지속 라운드 (1~10 정수, 필수)
- **옵션3**: 스킬 취소 (ADMIN 전용, 선택사항)

### 3.2 명령어 로직
```
/스킬 [영웅이름] [라운드수] [취소할_스킬]
```

- 옵션3 선택 시: 옵션1, 2 무시하고 선택된 스킬 취소
- 드롭다운에는 **사용 가능한 스킬만** 표시
- 필드에 이미 존재하는 스킬은 드롭다운에서 제외

### 3.3 권한 시스템
- **일반 유저**: 자신에게 허용된 스킬만 사용 가능
- **ADMIN**: 모든 스킬 사용 가능 + 취소 옵션 사용 가능

---

## 4. 스킬 시스템 핵심 규칙

### 4.1 동시 사용 제한
- **전역 제한**: 한 필드에 같은 스킬은 하나만 존재 가능
- **개인 제한**: 한 유저/몬스터는 동시에 하나의 스킬만 사용 가능 (향후 조합 스킬 확장 가능성 고려)

### 4.2 재사용 제한
- **쿨타임**: 없음 (스킬 종료 후 바로 재사용 가능)
- **전투 내 제한**: 없음 (같은 전투에서 여러 번 사용 가능)
- **전투 종료**: 모든 스킬 상태 초기화

### 4.3 라운드 관리
- **카운팅 시작**: 스킬 사용한 라운드부터 카운팅
- **자동 해제**: 지정된 라운드 종료 시 자동 해제
- **기존 시스템 연동**: mob_setting.py의 라운드와 동기화

---

## 5. 영웅별 스킬 상세 명세

### 5.1 자기 자신에게만 적용되는 스킬

#### 오닉셀
- **효과**: 주사위 값이 최대 150, 최소 50으로 고정
- **대상**: 스킬 사용자 본인만
- **구현**: 주사위 굴림 후 값 보정

#### 콜 폴드  
- **효과**: 주사위 값이 0 또는 100만 나옴
- **확률**: 0이 40%, 100이 60%
- **대상**: 몬스터, ADMIN, 스킬 사용자 본인만
- **구현**: 주사위 굴림 후 확률적 값 변경

#### 황야
- **효과**: 한 턴에 두 가지 행동 가능
- **행동**: 공격+공격, 공격+회복, 회복+회복
- **대상**: 몬스터, ADMIN, 스킬 사용자 본인만
- **구현**: 
  - 몬스터: 두 번의 별도 주사위 굴림
  - 유저: 두 번의 `/회복` 명령어 사용 가능

#### 스트라보스
- **효과**: 주사위 값이 최대 150, 최소 75로 고정  
- **대상**: 스킬 사용자 본인만
- **구현**: 주사위 굴림 후 값 보정

### 5.2 대상 선택이 필요한 스킬

#### 스카넬
- **효과**: 
  1. 본인이 받는 데미지를 다른 유저와 공유
  2. 퇴장 시(스킬 종료 시) 운석 공격 (광역공격)
- **운석 공격**: 주사위 50 미만인 유저에게 체력 -20
- **대상 선택**: 유저가 사용 시 다른 유저 또는 적(몬스터, ADMIN) 선택 가능/유저가 선택시 운석공격은 선택된 유저 또는 적(몬스터, ADMIN)에게만 적용됨

#### 루센시아  
- **효과**: 체력을 소모하여 사망한 유저 부활
- **소모량**: nn번 소모하여 총 mm 체력으로 부활 (전역변수)
- **특별 우선순위**: 유저 ID "1237738945635160104" 최우선 부활
- **대상 선택**: 유저가 사용 시 다른 유저 또는 적(몬스터, ADMIN) 선택 가능

#### 비렐라
- **효과**: 대상을 전투에서 배제 (3라운드 또는 저항 성공까지)
- **저항 시스템**: 매 턴마다 저항 주사위 굴림 (50 이상 시 탈출)
- **실패 시**: 해당 턴의 공격/방어 주사위가 0으로 처리
- **AI 난이도별 타겟팅**:
  - 보통 이하: 랜덤 유저 선택
  - 어려움 이상: 가장 위협적인 유저 선택
- **대상 선택**: 유저가 사용 시 다른 유저 또는 적(몬스터, ADMIN) 선택 가능

#### 그림
- **단계**: 
  1. 1턴 준비 (스킬 사용 다음 라운드에 발동)
  2. 체력이 가장 낮은 유저 확정 사망 (주사위 1000)
- **타겟 우선순위**:
  1. 체력이 가장 낮은 유저
  2. 동률 시: 특별 유저 ID 목록에서 스킬 미사용자 우선
  3. 그래도 동률 시: 랜덤 선택
- **방어**: 피닉스 스킬로만 방어 가능
- **대상 선택**: 유저가 사용 시 다른 유저 또는 적(몬스터, ADMIN) 선택 가능

#### 피닉스 (유저 전용)
- **효과**: 
  1. 죽은 유저 소생
  2. 그림 공격 방어 (유일한 방어 수단)
- **발동 타이밍**: 그림 발동 전 미리 사용 또는 그림과 동시 반응 가능
- **체력 소모**: 없음
- **대상**: 스킬 사용자 본인 또는 다른 유저

#### 닉사라
- **효과**: 대상을 전투에서 배제
- **배제 기간**: |공격자 주사위 - 방어자 주사위| ÷ 10 (내림) 라운드
- **즉시 적용**: 스킬 발동 즉시 해당 라운드부터 적용
- **주사위 무효화**: 이미 굴린 주사위 무효 처리 후 재굴림
- **AI 난이도별 타겟팅**: 비렐라와 동일
- **대상 선택**: 유저가 사용 시 다른 유저 또는 적(몬스터, ADMIN) 선택 가능

#### 제룬카
- **몬스터/ADMIN 사용 시**: 
  - 체력이 가장 낮은 유저 또는 특별 유저 ID 목록의 유저 타겟팅
  - 타겟팅된 유저는 모든 공격에서 -20 데미지 (기존 -10 대신)
- **유저 사용 시**:
  - 주사위 굴림: 50 이상 시 본인 공격만 -20 적용
  - 90 이상 시 모든 유저 공격에 -20 적용

### 5.3 전역 효과 스킬

#### 오리븐
- **몬스터 사용 시**: 해당 라운드 모든 유저 주사위 -10
- **유저 사용 시**: 해당 라운드 적(몬스터/ADMIN) 주사위 -10  

#### 카론
- **기본 효과**: 모든 유저가 데미지 공유
- **유저 사용 시**: 적(몬스터/ADMIN)도 데미지 공유에 포함
- **공유 방식**: 한 명이 받은 데미지를 모든 대상이 동일하게 받음

### 5.4 특수 공격 스킬

#### 볼켄
- **1-3라운드**: 모든 주사위 값 1로 고정
- **4라운드**: 선별 주사위 굴림 (50 미만인 대상들 선별)
- **4-5라운드**: 선별된 대상들에게 기존 집중공격 시스템 적용 (다중 대상 가능)

#### 단목
- **발동**: 모든 유저가 주사위 굴림
- **관통 시스템**: 
  - 50 미만 유저 + 그 다음 순서 유저가 피격
  - 직접 피격(50 미만): 체력 -20
  - 관통 피격(다음 순서): 체력 -10
  - 연속 50 미만 시: 해당 수만큼 다음 유저들 관통 피격
- **유저 사용 시**: 몬스터/ADMIN에게 방어 무시 -30 데미지

#### 넥시스 (특별 제한)
- **사용자**: 오직 유저 ID "1059908946741166120"만 사용 가능
- **효과**: 적에게 확정적으로 -30 체력 차감

---

## 6. 시스템 통합 명세

### 6.1 기존 시스템과의 연동점
- **mob_setting.py**: 전투 상태 관리, 라운드 카운터 연동
- **battle_admin.py**: ADMIN 명령어 연동
- **기존 권한 시스템**: 동일한 ADMIN 권한 체크 사용

### 6.2 주사위 시스템 연동
- **보정 시점**: 다이스 봇 메시지 파싱 후 값 보정
- **무효화 처리**: "(영웅이름)의 능력이 발동됩니다. 주사위를 다시 굴립니다."
- **특수 값 설정**: 콜 폴드, 그림 등의 고정값 적용

### 6.3 라운드 관리 연동
- **라운드 동기화**: 기존 전투 시스템의 라운드와 완전 동기화
- **스킬 카운터**: 각 스킬별 남은 라운드 추적
- **자동 해제**: 라운드 종료 시 해당 스킬들 자동 해제

---

## 7. 데이터 구조 및 저장

### 7.1 skill_states.json 구조
```json
{
  "channel_12345": {
    "battle_active": true,
    "current_round": 5,
    "active_skills": {
      "onixel": {
        "user_id": "123456789",
        "user_name": "펀처", 
        "target_id": "123456789",
        "target_name": "펀처",
        "rounds_left": 3,
        "started_round": 3
      },
      "karon": {
        "user_id": "monster",
        "user_name": "고블린왕",
        "target_id": "all_users",
        "target_name": "모든 유저",
        "rounds_left": 1,
        "started_round": 5
      }
    },
    "disabled_skills": ["grim_preparing"],
    "special_effects": {
      "virella_bound": ["987654321"],
      "nixara_excluded": ["111222333"]
    }
  }
}
```

### 7.2 skill_config.json 구조
```json
{
  "lucencia": {
    "health_cost": 3,
    "revival_health": 5
  },
  "priority_users": [
    "1237738945635160104",
    "1059908946741166120"
  ],
  "skill_users": {
    "오닉셀": ["all_users", "admin", "monster"],
    "피닉스": ["users_only"],
    "넥시스": ["1059908946741166120"]
  }
}
```

### 7.3 user_skills.json 구조  
```json
{
  "123456789": {
    "allowed_skills": ["피닉스", "오리븐", "카론"],
    "display_name": "펀처"
  },
  "987654321": {
    "allowed_skills": ["루센시아", "비렐라", "제룬카"], 
    "display_name": "휘슬"
  }
}
```

### 7.4 백업 DB (SQLite)
```sql
CREATE TABLE skill_states (
    channel_id TEXT PRIMARY KEY,
    battle_data TEXT,  -- JSON 데이터
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 8. UI/UX 명세

### 8.1 /스킬 명령어 응답
```
사용자가 옵션 선택 → ephemeral 응답 → 대상 선택 (필요시) → 확인 메시지 → 스킬 발동
```

### 8.2 대상 선택 시스템
- **검색 기반**: 25개 초과 시 자동완성 검색 제공
- **닉네임 기반**: known_names 리스트로 실명 매칭
- **표시 형태**:
  - 유저: "펀처 (아카시하지메)"
  - 몬스터: 설정된 몬스터 이름 (예: "고블린왕")
  - ADMIN: 설정된 ADMIN 이름

### 8.3 전투 상태 화면 추가
```
⚔️ 고블린왕 전투
라운드 3

🎯 고블린왕
🟩🟩🟩🟩🟩🟩🟩⬜⬜⬜
체력: 70/100

펀처                    휘슬
🟩🟩🟩🟩⬜⬜⬜⬜⬜⬜      🟨🟨🟨⬜⬜⬜⬜⬜⬜⬜
체력: 40/100           체력: 30/100

📋 턴 순서
고블린왕 → **펀처** → 휘슬

🔮 현재 활성 스킬:
🔥 오닉셀 (3라운드 남음) - 사용자: 펀처
⚡ 카론 (1라운드 남음) - 사용자: 고블린왕
🌿 비렐라 - 배제됨: 휘슬 (저항 기회 2회 남음)
```

### 8.4 스킬 발동 메시지들
```
✅ 오닉셀의 힘이 펀처에게 적용되었습니다! (5라운드)
❌ 해당 스킬이 이미 사용 중입니다.
⚠️ 전투 중이 아닙니다.
🔒 권한이 없습니다.
💀 그림의 능력이 발동됩니다. 주사위를 다시 굴립니다.
```

### 8.5 중요 스킬 확인창
- **대상 스킬**: 그림, 넥시스, 볼켄 등
- **확인 메시지**: "정말로 [스킬명]을 사용하시겠습니까? 이 행동은 되돌릴 수 없습니다."

---

## 9. 성능 및 안정성

### 9.1 메모리 관리
- **캐싱**: 활성 스킬 상태를 메모리에 캐싱
- **주기적 저장**: 30초마다 JSON 파일에 저장
- **즉시 저장**: 중요한 변경사항(스킬 적용/해제) 시 즉시 저장

### 9.2 봇 재시작 복구
- **백업 DB**: SQLite로 중요 데이터 백업
- **자동 복구**: 봇 시작 시 백업 데이터로 상태 복구
- **무결성 검사**: 복구 시 데이터 유효성 검증

### 9.3 에러 처리
- **단계별 롤백**: 스킬 적용 실패 시 이전 상태로 롤백
- **로깅**: 모든 스킬 관련 오류 상세 로깅
- **안전 장치**: 크리티컬 에러 시 스킬 시스템 일시 비활성화

---

## 10. 확장성 고려사항

### 10.1 새 스킬 추가
- **플러그인 방식**: heroes/ 폴더에 새 파일 추가만으로 확장
- **자동 로딩**: 시작 시 heroes/ 폴더의 모든 스킬 자동 로드
- **설정 연동**: config 파일만 수정하면 새 스킬 활성화

### 10.2 조합 스킬 준비
- **현재**: 한 사용자당 하나의 스킬만 사용 가능
- **향후**: 특정 조합의 스킬 동시 사용 가능하도록 확장 여지

### 10.3 권한 시스템 확장
- **현재**: 유저별 허용 스킬 목록
- **향후**: 레벨, 업적 등에 따른 동적 권한 시스템 확장 가능

---

## 11. 구현 우선순위

### Phase 1: 기본 프레임워크
1. skill_manager.py - 기본 상태 관리
2. skill.py - /스킬 명령어 구현  
3. 기본 영웅 3-4개 구현 (오닉셀, 피닉스, 오리븐, 카론)

### Phase 2: 복잡한 스킬들
4. 대상 선택 시스템 구현
5. 특수 공격 스킬들 (그림, 볼켄, 단목)
6. 배제 시스템 (비렐라, 닉사라)

### Phase 3: 통합 및 안정화
7. mob_setting.py 연동 완성
8. 백업/복구 시스템 구현
9. UI 최적화 및 테스트

### Phase 4: 확장 기능
10. 나머지 모든 스킬 구현
11. 성능 최적화
12. 로깅 및 모니터링 시스템

---

## 12. 참고 정보

### 실제 유저명 목록
```python
known_names = {
    "아카시하지메", "아카시 하지메", "아카시_하지메",
    "펀처", "유진석", "휘슬", "배달기사", "페이",
    "로메즈아가레스", "로메즈 아가레스", "로메즈_아가레스", 
    "레이나하트베인", "레이나 하트베인", "레이나_하트베인",
    "비비", "오카미나오하", "오카미 나오하", "오카미_나오하",
    "카라트에크", "토트", "처용", "멀플리시", "멀 플리시", "멀_플리시",
    "코발트윈드", "옥타", "베레니케", "안드라블랙", "안드라 블랙", "안드라_블랙",
    "봉고3호", "봉고 3호", "봉고_3호", "몰", "베니", "백야", "루치페르",
    "벨사이르드라켄리트", "벨사이르 드라켄리트", "벨사이르_드라켄리트",
    "불스", "퓨어메탈", "퓨어 메탈", "퓨어_메탈",
    "노단투", "노 단투", "노_단투", "라록", "아카이브", "베터", "메르쿠리", 
    "마크-112", "마크112", "스푸트니크2세", "스푸트니크 2세", "스푸트니크_2세",
    "이터니티", "커피머신"
}
```

### 특별 유저 ID
- **루센시아 우선 부활**: "1237738945635160104"  
- **넥시스 전용**: "1059908946741166120"
- **그림/제룬카 우선 타겟**: 위 두 ID + 추가 설정 가능

---

이 문서는 Discord 봇 스킬 시스템의 완전한 기획서입니다. 모든 요구사항, 상세 명세, 구현 방향이 포함되어 있어 바로 개발에 착수할 수 있습니다.